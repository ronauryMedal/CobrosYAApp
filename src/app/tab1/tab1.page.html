<app-header title="Dashboard"></app-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Estado de carga -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando dashboard...</p>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorMessage && !isLoading" class="error-container">
    <ion-card color="danger">
      <ion-card-content>
        <ion-icon name="alert-circle" slot="start"></ion-icon>
        <p>{{ errorMessage }}</p>
        <ion-button fill="clear" (click)="cargarDashboard()">
          Reintentar
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Pantalla de bienvenida cuando no hay datos o métricas vacías -->
  <div *ngIf="!isLoading && !errorMessage && (!dashboardData || !tieneDatosValidos())" class="no-data-container">
    <ion-card class="welcome-card">
      <ion-card-content>
        <div class="welcome-content">
          <ion-icon name="happy-outline" class="welcome-icon"></ion-icon>
          <h2>¡Bienvenido a PagosYA!</h2>
          <p>Tu plataforma de adelantos de nómina</p>
          <div class="features">
            <div class="feature-item">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <span>Proceso rápido y sencillo</span>
            </div>
            <div class="feature-item">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <span>Sin papeleos complicados</span>
            </div>
            <div class="feature-item">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <span>Descuentos automáticos</span>
            </div>
          </div>
          <ion-button expand="block" (click)="irASolicitarAdelanto()" class="start-button">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Comenzar mi primer adelanto
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Contenido del dashboard solo cuando hay datos válidos -->
  <div *ngIf="!isLoading && !errorMessage && dashboardData && tieneDatosValidos()">
    <!-- Resumen de Adelantos -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="card-outline" slot="start"></ion-icon>
          Resumen de Adelantos
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6">
              <div class="stat-item">
                <h3>{{ dashboardData.resumen.adelantosPendientes || 0 }}</h3>
                <p>Pendientes</p>
              </div>
            </ion-col>
            <ion-col size="6">
              <div class="stat-item">
                <h3>{{ formatearMoneda(dashboardData.resumen.montoTotalAdelantos || 0) }}</h3>
                <p>Total Adelantos</p>
              </div>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="6">
              <div class="stat-item">
                <h3>{{ formatearMoneda(dashboardData.resumen.montoDisponible || 0) }}</h3>
                <p>Disponible</p>
              </div>
            </ion-col>
            <ion-col size="6">
              <div class="stat-item">
                <h3>{{ formatearMoneda(dashboardData.resumen.proximoPago || 0) }}</h3>
                <p>Próximo Pago</p>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Adelantos Recientes -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="time-outline" slot="start"></ion-icon>
          Adelantos Recientes
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="dashboardData.adelantosRecientes && dashboardData.adelantosRecientes.length > 0">
          <ion-item *ngFor="let adelanto of dashboardData.adelantosRecientes">
            <ion-icon name="card-outline" slot="start"></ion-icon>
            <ion-label>
              <h3>{{ adelanto.descripcion }}</h3>
              <p>{{ formatearFecha(adelanto.fecha) }} • {{ formatearMoneda(adelanto.monto) }}</p>
            </ion-label>
            <ion-badge slot="end" [color]="getEstadoColor(adelanto.estado)">
              {{ adelanto.estado | titlecase }}
            </ion-badge>
          </ion-item>
        </ion-list>
        <div *ngIf="!dashboardData.adelantosRecientes || dashboardData.adelantosRecientes.length === 0" class="empty-state">
          <ion-icon name="card-outline" class="empty-icon"></ion-icon>
          <h3>¡Bienvenido a PagosYA!</h3>
          <p>Aún no has solicitado ningún adelanto. ¿Necesitas ayuda financiera?</p>
          <ion-button fill="outline" (click)="irASolicitarAdelanto()" class="action-button">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Solicitar mi primer adelanto
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Últimos Pagos -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="cash-outline" slot="start"></ion-icon>
          Últimos Pagos
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list *ngIf="dashboardData.ultimosPagos && dashboardData.ultimosPagos.length > 0">
          <ion-item *ngFor="let pago of dashboardData.ultimosPagos">
            <ion-icon name="cash-outline" slot="start"></ion-icon>
            <ion-label>
              <h3>{{ pago.descripcion }}</h3>
              <p>{{ formatearFecha(pago.fecha) }} • {{ formatearMoneda(pago.monto) }}</p>
            </ion-label>
            <ion-badge slot="end" [color]="getTipoColor(pago.tipo)">
              {{ pago.tipo | titlecase }}
            </ion-badge>
          </ion-item>
        </ion-list>
        <div *ngIf="!dashboardData.ultimosPagos || dashboardData.ultimosPagos.length === 0" class="empty-state">
          <ion-icon name="cash-outline" class="empty-icon"></ion-icon>
          <h3>Sin actividad de pagos</h3>
          <p>Cuando solicites adelantos, aquí verás el historial de tus pagos y descuentos.</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
